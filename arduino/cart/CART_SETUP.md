# Инструкция по настройке тележки для корма

## Описание

Автоматическая логика работы тележки (движение определяется по датчикам):
- Сервопривод для подачи корма
- Концевые выключатели для автоматического определения мест остановки
- RFID считыватель для вторичной проверки места остановки
- Система автоматически определяет движение тележки по изменению состояния датчиков

## Подключение компонентов

### Сервопривод
- **Пин:** 9
- Подключите сигнальный провод сервопривода к пину 9
- Питание и земля - к соответствующим выводам Arduino

### Концевые выключатели
- **Пин под выдачей корма:** 2
- **Пин на месте высыпания:** 3
- Подключите один контакт к пину Arduino, второй к GND
- Используется INPUT_PULLUP, поэтому при нажатии выключатель должен замыкать на GND

### RFID считыватель (MFRC522)
- **SS (SDA):** Пин 10
- **RST:** Пин 8
- **MOSI:** Пин 11 (SPI)
- **MISO:** Пин 12 (SPI)
- **SCK:** Пин 13 (SPI)
- Подключите питание 3.3V и GND

## Настройка RFID меток

1. Загрузите код в Arduino
2. Откройте Serial Monitor (115200 baud)
3. Поднесите RFID метку к считывателю
4. Отправьте команду `read` или `читать`
5. Скопируйте выведенный код метки
6. Замените значения в коде:
   ```cpp
   byte FEED_LOCATION_TAG[] = {0xXX, 0xXX, 0xXX, 0xXX};  // Ваша метка под выдачей
   byte DUMP_LOCATION_TAG[] = {0xXX, 0xXX, 0xXX, 0xXX};  // Ваша метка на месте высыпания
   ```
7. Загрузите обновленный код

## Настройка параметров

В начале файла `cart_logic.ino` можно изменить:

```cpp
#define SERVO_CLOSED_ANGLE 0    // Угол закрытого положения (0-180)
#define SERVO_OPEN_ANGLE 90     // Угол открытого положения (0-180)
#define FEEDING_TIME 5000        // Время подачи корма в миллисекундах
```

## Логика работы (автоматическая)

1. **Старт:** Тележка должна находиться под выдачей корма
   - Концевой выключатель должен быть нажат
   - RFID метка должна быть обнаружена
   - Система автоматически выведет сигнал готовности к загрузке (через Serial, потом через MQTT)

2. **Загрузка корма:**
   - Система периодически выводит сигнал готовности
   - Когда корм загружен, отправьте команду `ready` или `готово` через Serial Monitor
   - **В будущем:** команда будет приходить автоматически через MQTT брокер

3. **Автоматическое движение к месту высыпания:**
   - Система автоматически определяет, когда тележка покинула место загрузки
   - При достижении места высыпания система автоматически определяет остановку по:
     - Концевому выключателю
     - RFID метке
   - Никаких ручных команд не требуется

4. **Автоматическая подача корма:**
   - После автоматического подтверждения места система откроет сервопривод
   - Корм будет подаваться заданное время (по умолчанию 5 секунд)
   - После завершения сервопривод автоматически закроется

5. **Автоматический возврат:**
   - Система автоматически определяет возврат тележки по концевым выключателям и RFID
   - При достижении места загрузки цикл автоматически повторяется
   - Никаких ручных команд не требуется

## Команды через Serial Monitor

- `ready` / `готово` - Корм загружен, можно ехать
- `read` / `читать` - Прочитать RFID метку (для настройки)
- `test` / `тест` - Тестирование всех компонентов
- `servo_open` / `открыть` - Открыть сервопривод вручную
- `servo_close` / `закрыть` - Закрыть сервопривод вручную
- `status` / `статус` - Показать текущий статус системы
- `help` / `помощь` - Показать справку по командам

## Тестирование

После подключения всех компонентов:

1. Отправьте команду `test` для проверки всех компонентов
2. Проверьте работу концевых выключателей (нажмите и отпустите)
3. Проверьте работу сервопривода (команды `servo_open` / `servo_close`)
4. Прочитайте RFID метки командой `read`

## Устранение неполадок

### RFID не работает
- Проверьте подключение SPI (MOSI, MISO, SCK)
- Проверьте питание 3.3V (не 5V!)
- Убедитесь, что SS и RST подключены правильно

### Концевые выключатели не срабатывают
- Проверьте подключение к пинам 2 и 3
- Убедитесь, что выключатель замыкает на GND при нажатии
- Проверьте команду `test` для диагностики

### Сервопривод не работает
- Проверьте подключение к пину 9
- Проверьте питание сервопривода (может потребоваться внешний источник)
- Используйте команды `servo_open` / `servo_close` для тестирования

## Библиотеки

Убедитесь, что установлены следующие библиотеки:
- `Servo` (встроенная в Arduino IDE)
- `SPI` (встроенная в Arduino IDE)
- `MFRC522` (установите через Library Manager: "MFRC522" by GithubCommunity)

## Примечания

- Моторы отключены - тележка движется автоматически (или ее перемещают), система определяет движение по датчикам
- Управление полностью автоматическое - система сама определяет все этапы движения
- Только команда "ready" требует ручного ввода (через Serial), в будущем будет через MQTT брокер
- MQTT заменен на Serial для отладки (Serial.println вместо отправки, Serial.read вместо получения)
- В будущем команда "ready" будет приходить автоматически через MQTT брокер
