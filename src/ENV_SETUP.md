# Инструкция по настройке переменных окружения

## Расположение .env файлов

В проекте используется **2 .env файла**:

1. **Основной .env файл** - находится в директории `src/`
   - Используется для всех сервисов (backend, frontend, nginx, db, mqtt)
   - Содержит настройки базы данных, MQTT, портов и т.д.

2. **Клиентский .env файл** - находится в директории `src/frontend/`
   - Используется только для сборки фронтенда
   - Обычно содержит только `VITE_API_BASE_URL=/api`

## Как создать .env файл

### Шаг 1: Создайте основной .env файл

Скопируйте пример файла и переименуйте его:

```bash
cd src
cp env.example .env
```

Или создайте файл `src/.env` вручную и скопируйте содержимое из `env.example`.

### Шаг 2: Отредактируйте .env файл

Откройте файл `src/.env` в текстовом редакторе и измените значения под вашу конфигурацию.

**Важно для Docker:**
- `PG_HOST=db` - используйте имя сервиса из docker-compose.yml
- `BACK_HOST=backend` - используйте имя сервиса из docker-compose.yml
- `MQTT_SERVER=mqtt` - для локального брокера в Docker используйте `mqtt`
- `MQTT_SERVER=158.160.94.8` - для внешнего брокера используйте IP адрес

### Шаг 3: Создайте клиентский .env файл (опционально)

Если нужно изменить настройки фронтенда:

```bash
cd src/frontend
echo "VITE_API_BASE_URL=/api" > .env
```

## Пример минимального .env файла для Docker

```env
# База данных
PG_HOST=db
PG_USER=postgres
PG_PASSWORD=your_password
PG_DB=feed-fish
PG_PORT=5432

# Backend
BACK_PORT=8000
BACK_HOST=backend
ALLOWED_HOSTS=158.160.94.8,localhost

# Nginx
NGINX_PORT=80

# MQTT (для локального брокера в Docker)
MQTT_SERVER=mqtt
MQTT_PORT=1883
MQTT_USER=user
MQTT_PASSWORD=iiot-mqtt-fish
```

## Пример .env файла для внешнего MQTT брокера

Если MQTT брокер находится на внешнем сервере:

```env
# ... остальные настройки ...

# MQTT (для внешнего брокера)
MQTT_SERVER=158.160.94.8
MQTT_PORT=1883
MQTT_USER=user
MQTT_PASSWORD=iiot-mqtt-fish
```

## Переменные окружения

### База данных PostgreSQL

| Переменная | Описание | Значение по умолчанию | Пример |
|-----------|----------|----------------------|--------|
| `PG_HOST` | Адрес хоста БД | `localhost` | `db` (для Docker) |
| `PG_USER` | Пользователь БД | `postgres` | `postgres` |
| `PG_PASSWORD` | Пароль БД | `0000` | `your_secure_password` |
| `PG_DB` | Название БД | `feed-fish` | `feed-fish` |
| `PG_PORT` | Порт БД | `5432` | `5432` |

### Backend сервер

| Переменная | Описание | Значение по умолчанию | Пример |
|-----------|----------|----------------------|--------|
| `BACK_PORT` | Порт backend | `8000` | `8000` |
| `BACK_HOST` | Адрес backend | `localhost` | `backend` (для Docker) |
| `ALLOWED_HOSTS` | Разрешенные хосты | `158.160.94.8,localhost` | `158.160.94.8,localhost,example.com` |

### Nginx

| Переменная | Описание | Значение по умолчанию | Пример |
|-----------|----------|----------------------|--------|
| `NGINX_PORT` | Порт Nginx | `80` | `80` или `8080` |

### MQTT брокер

| Переменная | Описание | Значение по умолчанию | Пример |
|-----------|----------|----------------------|--------|
| `MQTT_SERVER` | Адрес MQTT брокера | `158.160.94.8` | `mqtt` (локальный) или `158.160.94.8` (внешний) |
| `MQTT_PORT` | Порт MQTT | `1883` | `1883` |
| `MQTT_USER` | Пользователь MQTT | `user` | `user` |
| `MQTT_PASSWORD` | Пароль MQTT | `iiot-mqtt-fish` | `your_mqtt_password` |
| `MQTT_REQUESTS_TOPIC` | Топик запросов | `bunker` | `bunker` |
| `MQTT_CART_TOPIC` | Топик тележки | `cart` | `cart` |
| `MQTT_LOGS_TOPIC` | Топик логов | `logs` | `logs` |

## Проверка настроек

После создания .env файла проверьте, что все переменные установлены:

```bash
# В директории src
docker-compose config
```

Эта команда покажет финальную конфигурацию с подставленными значениями из .env файла.

## Безопасность

⚠️ **Важно:** 
- Никогда не коммитьте `.env` файлы в git!
- Файл `.env.example` содержит только примеры без реальных паролей
- Используйте сложные пароли в продакшн окружении
- Регулярно меняйте пароли

## Решение проблем

### Проблема: Переменные не применяются

1. Убедитесь, что файл называется именно `.env` (с точкой в начале)
2. Проверьте, что файл находится в правильной директории (`src/`)
3. Перезапустите контейнеры: `docker-compose down && docker-compose up -d`

### Проблема: Неправильный формат

- Не используйте пробелы вокруг знака `=`
- Не используйте кавычки для значений (кроме случаев, когда это необходимо)
- Каждая переменная должна быть на отдельной строке

Правильно:
```env
MQTT_SERVER=158.160.94.8
```

Неправильно:
```env
MQTT_SERVER = "158.160.94.8"
MQTT_SERVER='158.160.94.8'
```
