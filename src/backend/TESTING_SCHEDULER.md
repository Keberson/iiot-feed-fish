# Инструкция по тестированию системы расписания кормления

## Проверка компонентов системы

### 1. Проверка логики вычисления времени

Запустите тестовый скрипт:
```bash
cd src/backend
python manage.py shell
>>> from fish_app.test_scheduler_logic import test_calculate_feeding_times
>>> test_calculate_feeding_times()
```

Ожидаемые результаты:
- **1 раз в день** → `12:00`
- **2 раза в день** → `6:00, 18:00`
- **3 раза в день** → `4:00, 12:00, 20:00`
- **4 раза в день** → `3:00, 9:00, 15:00, 21:00`
- **Кастомное время** → указанное время

### 2. Проверка планирования задач

#### 2.1. Создание задачи кормления

1. Создайте задачу кормления через API или UI:
   ```bash
   POST /api/feeding
   {
     "pool_id": "<uuid бассейна>",
     "feed_id": "<uuid корма>",
     "weight": 1.5,
     "period_id": "<uuid периода '1 раз в день'>"
   }
   ```

2. Проверьте логи backend:
   ```bash
   docker-compose logs backend | grep "Запланирована"
   ```
   
   Должна появиться запись:
   ```
   Запланирована отправка кормления для задачи {uuid} в 12:00
   ```

#### 2.2. Просмотр запланированных задач

```bash
GET /api/scheduler/jobs
```

Ответ должен содержать список всех запланированных задач с временем следующего запуска.

### 3. Проверка отправки в MQTT

#### 3.1. Подписка на MQTT топик

Используйте MQTT клиент для подписки на топик `bunker`:

```bash
mosquitto_sub -h 158.160.94.8 -p 1883 -u user -P iiot-mqtt-fish -t bunker -v
```

Или используйте онлайн клиент: https://www.hivemq.com/demos/websocket-client/

#### 3.2. Создание тестовой задачи с ближайшим временем

1. Создайте задачу с кастомным временем через 1-2 минуты от текущего времени
2. Подождите наступления времени
3. Проверьте, что сообщение появилось в MQTT топике

Ожидаемое сообщение в MQTT:
```json
{
  "pool_id": "<uuid>",
  "feed_id": "<uuid>",
  "weight": 1.5,
  "pool_name": "Бассейн №1",
  "feed_name": "Стартовый корм"
}
```

### 4. Проверка обновления задач

1. Обновите существующую задачу кормления (измените период или время)
2. Проверьте логи - старые задачи должны быть удалены, новые запланированы
3. Проверьте `/api/scheduler/jobs` - должны быть только новые задачи

### 5. Проверка удаления задач

1. Удалите задачу кормления
2. Проверьте логи - запланированные задачи должны быть удалены
3. Проверьте `/api/scheduler/jobs` - задачи для удаленной FeedingTask не должны присутствовать

### 6. Проверка перепланирования при перезапуске

1. Создайте несколько задач кормления
2. Перезапустите backend:
   ```bash
   docker-compose restart backend
   ```
3. Проверьте логи - должны появиться записи о перепланировании всех задач
4. Проверьте `/api/scheduler/jobs` - все задачи должны быть запланированы

## Проверка логов

### Важные записи в логах:

1. **При запуске:**
   ```
   Планировщик задач запущен
   Перепланирование X задач кормления
   Все задачи кормления перепланированы
   Планировщик задач кормления инициализирован
   ```

2. **При создании/обновлении задачи:**
   ```
   Запланирована отправка кормления для задачи {uuid} в {время}
   ```

3. **При отправке сообщения:**
   ```
   Отправлена команда кормления: бассейн={name}, корм={name}, масса={weight} кг
   MQTT: Команда кормления отправлена в топик bunker: {payload}
   ```

4. **При удалении задачи:**
   ```
   Удалена запланированная задача {job_id}
   ```

## Возможные проблемы и решения

### Проблема: Задачи не планируются

**Решение:**
1. Проверьте логи на наличие ошибок
2. Убедитесь, что сигналы Django зарегистрированы (проверьте `apps.py`)
3. Проверьте, что планировщик запущен (должна быть запись в логах)

### Проблема: Сообщения не отправляются в MQTT

**Решение:**
1. Проверьте подключение к MQTT брокеру (логи должны содержать "MQTT: Подключение установлено")
2. Проверьте настройки MQTT в `settings.py`
3. Проверьте доступность MQTT брокера: `158.160.94.8:1883`

### Проблема: Неправильное время кормления

**Решение:**
1. Проверьте логику в `calculate_feeding_times()`
2. Запустите тестовый скрипт `test_scheduler_logic.py`
3. Проверьте, что период правильно сохранен в базе данных

## Автоматическое тестирование

Для автоматического тестирования можно использовать тестовый скрипт:

```bash
cd src/backend
python manage.py shell < fish_app/test_scheduler_logic.py
```

Это проверит логику вычисления времени для всех типов периодов.
